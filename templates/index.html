<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Task Reminder Agent</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    background: linear-gradient(to right, #a8edea, #fed6e3);
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .container {
    max-width: 700px;
    margin-top: 40px;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  .task-item {
    transition: background-color 0.3s;
  }
  .task-item:hover {
    background-color: #f1f9ff;
  }
</style>
</head>
<body>
<div class="container">
  <h1 class="mb-4 text-center">AI Task Reminder Agent</h1>

  <form id="taskForm" class="row g-3 mb-4">
    <div class="col-md-5">
      <select id="categorySelect" class="form-select" required>
        <option value="" disabled selected>Select Category</option>
        {% for cat in categories %}
          <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-7">
      <input list="taskSuggestions" id="taskInput" name="task" class="form-control" placeholder="Enter task" autocomplete="off" required />
      <datalist id="taskSuggestions"></datalist>
    </div>
    <div class="col-md-6">
      <input type="datetime-local" id="timeInput" name="time" class="form-control" required />
    </div>
    <div class="col-md-6 d-flex align-items-center">
      <button type="submit" class="btn btn-primary w-100">Add Task</button>
    </div>
  </form>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Your Tasks</h3>
    <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
  </div>

  <ul class="list-group" id="tasksList">
    {% for task in tasks %}
      <li class="list-group-item d-flex justify-content-between align-items-center task-item">
        <div>
          <strong>{{ task.task }}</strong> <br/>
          <small class="text-muted">{{ task.category }} | {{ task.time }}</small> <br/>
          <small>Status: <em>{{ task.status }}</em></small>
        </div>
      </li>
    {% else %}
      <li class="list-group-item">No tasks scheduled.</li>
    {% endfor %}
  </ul>
</div>

<!-- Reminder Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reminderModalLabel">Task Reminder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="modalCloseBtn"></button>
      </div>
      <div class="modal-body">
        <p id="taskDescription"></p>
        <p><strong>Category:</strong> <span id="taskCategory"></span></p>
        <p><strong>Scheduled Time:</strong> <span id="taskTime"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btnTaken">Taken</button>
        <button type="button" class="btn btn-danger" id="btnMissed">Missed</button>
      </div>
    </div>
  </div>
</div>

<!-- Alarm sound -->
<audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const categorySelect = document.getElementById('categorySelect');
  const taskInput = document.getElementById('taskInput');
  const taskSuggestions = document.getElementById('taskSuggestions');
  const taskForm = document.getElementById('taskForm');
  const tasksList = document.getElementById('tasksList');

  let currentTask = null;
  const alarmSound = document.getElementById('alarmSound');
  const reminderModal = new bootstrap.Modal(document.getElementById('reminderModal'));
  const taskDescription = document.getElementById('taskDescription');
  const taskCategory = document.getElementById('taskCategory');
  const taskTime = document.getElementById('taskTime');
  const btnTaken = document.getElementById('btnTaken');
  const btnMissed = document.getElementById('btnMissed');

  categorySelect.addEventListener('change', () => {
    const cat = categorySelect.value;
    if (!cat) {
      taskSuggestions.innerHTML = '';
      return;
    }
    fetch(`/tasks_suggestions/${encodeURIComponent(cat)}`)
      .then(res => res.json())
      .then(suggestions => {
        taskSuggestions.innerHTML = '';
        suggestions.forEach(s => {
          const option = document.createElement('option');
          option.value = s;
          taskSuggestions.appendChild(option);
        });
      });
  });

  taskForm.addEventListener('submit', e => {
    e.preventDefault();
    const task = taskInput.value.trim();
    const category = categorySelect.value;
    const time = document.getElementById('timeInput').value;

    if (!task || !category || !time) {
      alert('Please fill all fields.');
      return;
    }

    const formData = new FormData();
    formData.append('task', task);
    formData.append('category', category);
    formData.append('time', time);

    fetch('/add_task', {
      method: 'POST',
      body: formData,
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          addTaskToList(data);
          taskInput.value = '';
          document.getElementById('timeInput').value = '';
        } else {
          alert(data.message || 'Failed to add task');
        }
      })
      .catch(() => alert('Error adding task'));
  });

  function addTaskToList(task) {
    // Remove "No tasks scheduled" message if present
    if (tasksList.children.length === 1 && tasksList.children[0].textContent.includes('No tasks scheduled')) {
      tasksList.innerHTML = '';
    }

    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center task-item';

    li.innerHTML = `
      <div>
        <strong>${task.task}</strong> <br/>
        <small class="text-muted">${task.category} | ${task.time}</small> <br/>
        <small>Status: <em>pending</em></small>
      </div>
    `;

    tasksList.appendChild(li);
  }

  // Reminder popup & alarm sound logic

  setInterval(checkDueTasks, 10000); // every 10 seconds

  function checkDueTasks() {
    fetch('/check_due_tasks')
      .then(res => res.json())
      .then(data => {
        if (data.due_tasks.length > 0 && !currentTask) {
          currentTask = data.due_tasks[0]; // only show one at a time
          showReminder(currentTask);
        }
      });
  }

  function showReminder(task) {
    taskDescription.textContent = task.task;
    taskCategory.textContent = task.category;
    taskTime.textContent = new Date(task.time).toLocaleString();

    alarmSound.play();
    reminderModal.show();
  }

  btnTaken.addEventListener('click', () => {
    updateTaskStatus('taken');
  });

  btnMissed.addEventListener('click', () => {
    updateTaskStatus('missed');
  });

  document.getElementById('modalCloseBtn').addEventListener('click', () => {
    alarmSound.pause();
    alarmSound.currentTime = 0;
    currentTask = null;
  });

  function updateTaskStatus(status) {
    if (!currentTask) return;
    const formData = new FormData();
    formData.append('task_id', currentTask.id);
    formData.append('status', status);

    fetch('/update_task_status', {
      method: 'POST',
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alarmSound.pause();
        alarmSound.currentTime = 0;
        reminderModal.hide();
        currentTask = null;
        location.reload();
      } else {
        alert('Failed to update task status');
      }
    });
  }
</script>
</body>
</html>
